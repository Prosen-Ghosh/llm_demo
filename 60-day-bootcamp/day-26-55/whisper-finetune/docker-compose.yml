version: '3.8'

services:
  whisper-training:
    build: .
    container_name: whisper-bangla-training
    # runtime: nvidia  # Remove this line if not using NVIDIA GPU
    volumes:
      # Mount for cache and model outputs
      - ./output:/app/whisper-medium-bn
      - ./final_model:/app/whisper-medium-bn-final
      - ./tensorboard_logs:/app/runs
      - ./huggingface_cache:/app/.cache/huggingface
      # Mount for local datasets (if any)
      - ./data:/app/data
    environment:
      - HF_TOKEN=${HF_TOKEN:-}  # Set your Hugging Face token in .env file
      - PYTORCH_ENABLE_MPS_FALLBACK=1
      - TORCH_USE_CUDA_DSA=1
    # For MPS on M1, we need to add device mappings
    devices:
      - /dev/bus/usb:/dev/bus/usb  # For audio devices if needed
    # Increase shared memory for multiprocessing
    shm_size: '2gb'
    # Restart policy
    restart: unless-stopped
    # Set ulimits for stability
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536