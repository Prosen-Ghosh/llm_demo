from src.data_loader import CVEDataLoader
from src.embedding_engine import EmbeddingEngine
from src.chroma_manager import ChromaManager
from src.search_interface import VulnerabilitySearch
import json

def main():

    data_loader = CVEDataLoader()
    embedding_engine = EmbeddingEngine()
    chroma_manager = ChromaManager()
    search_engine = VulnerabilitySearch(chroma_manager, embedding_engine)

    print("Fetching CVE data...")
    cve_data = data_loader.fetch_nvd_data()
    data_loader.save_data(cve_data, 'cve_data.json')
    print(f"Fetched {len(cve_data)} CVEs")

    print("Generating document texts...")
    documents = embedding_engine.generate_document_text(cve_data)
    print(f"Generated {len(documents)} documents")
    embeddings = embedding_engine.encode_documents(documents)

    print("Adding CVEs to ChromaDB...")
    chroma_manager.create_collection()
    chroma_manager.add_cves(cve_data, documents, embeddings)

    print("Performing a sample search...")
    query = "RCE"
    results = search_engine.semantic_search(query, n_results=5, severity_filter="HIGH", min_cvss=0.0)

    print("Search results:")
    for result in results:
        print(json.dumps(result, indent=2))


if __name__ == "__main__":
    main()