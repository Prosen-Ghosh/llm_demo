import chromadb
from chromadb.config import Settings
import uuid
from typing import List, Dict

class ChromaManager:
    def __init__(self):
        self.client = None
        self._initialize_client()
        self.collection = None

    def _initialize_client(self):
        self.client = chromadb.Client()
    
    def create_collection(self, collection_name: str = 'cve_database'):
        if not self.client:
            self._initialize_client()

        self.collection = self.client.get_or_create_collection(
            name=collection_name,
            metadata={ "description": "Collection of CVE vulnerability data" }
        )

        return self.collection
    
    def add_cves(self, cve_data, documents, embeddings):
        """Add CVE data to ChromaDB"""
        if not self.collection:
            self.create_collection()
        
        # Generate IDs
        ids = [str(uuid.uuid4()) for _ in range(len(cve_data))]
        
        # Prepare metadata
        metadatas = []
        for cve in cve_data:
            metadata = {
                'cve_id': cve['cve_id'],
                'severity': cve.get('severity', 'UNKNOWN'),
                'cvss_score': str(cve.get('cvss_score', '')),
                'cwe_list': ', '.join(cve.get('cwe_list', [])),
                'affected_products': ', '.join(cve.get('affected_products', [])),
                'published_date': cve.get('published_date', '')
            }
            metadatas.append(metadata)
        
        # Add to collection
        self.collection.add(
            embeddings=embeddings.tolist(),
            documents=documents,
            metadatas=metadatas,
            ids=ids
        )
        
        print(f"Added {len(cve_data)} CVEs to the database")
    
    def search(self, query_embedding, n_results=5, filters=None):
        """Search the CVE database"""
        if not self.collection:
            raise Exception("Collection not initialized")
        
        results = self.collection.query(
            query_embeddings=query_embedding.tolist(),
            n_results=n_results,
            where=filters
        )
        return results
    
    def get_collection_stats(self):
        """Get statistics about the collection"""
        if not self.collection:
            return "No collection initialized"
        
        count = self.collection.count()
        return f"Collection contains {count} CVEs"