class VulnerabilitySearch:
    def __init__(self, chroma_manager, embedding_engine):
        self.chroma_manager = chroma_manager
        self.embedding_engine = embedding_engine

    def semantic_search(self, query, n_results = 5, severity_filter = None, min_cvss = None):

        filters = {}
        if severity_filter:
            filters['severity'] = severity_filter

        if min_cvss is not None:
            filters['cvss_score'] = { '$gte': str(min_cvss) }
        
        query_embedding = self.embedding_engine.encode_query(query)

        results = self.chroma_manager.search(
            query_embedding=query_embedding,
            n_results=n_results,
            # filters=filters if filters else None
        )

        return self._format_results(results)
    
    def _format_results(self, results):
        """Format search results for display"""
        formatted_results = []
        
        for i in range(len(results['documents'][0])):
            result = {
                'document': results['documents'][0][i],
                'metadata': results['metadatas'][0][i],
                'distance': results['distances'][0][i] if results['distances'] else None
            }
            formatted_results.append(result)
        
        return formatted_results
    
    def find_similar_vulnerabilities(self, cve_description, n_results=5):
        """Find vulnerabilities similar to a given description"""
        return self.semantic_search(cve_description, n_results)