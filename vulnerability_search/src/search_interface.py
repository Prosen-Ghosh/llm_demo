import numpy as np
class VulnerabilitySearch:
    def __init__(self, chroma_manager, embedding_engine):
        self.chroma_manager = chroma_manager
        self.embedding_engine = embedding_engine

    def semantic_search(self, query, n_results = 5, severity_filter = None, min_cvss = None):

        filters = self._build_filters(severity_filter, min_cvss)
        
        query_embedding = self.embedding_engine.encode_query(query)

        results = self.chroma_manager.search(
            query_embedding=query_embedding,
            n_results=n_results,
            filters=filters if filters else None
        )

        return self._format_results(results)
    
    def _build_filters(self, severity_filter, min_cvss):
        filters = {}
        
        if severity_filter and min_cvss:
            # Multiple conditions require $and operator
            filters = {
                "$and": [
                    {"severity": {"$eq": severity_filter}},
                    {"cvss_score": {"$gte": min_cvss}}
                ]
            }
        elif severity_filter:
            # Single condition
            filters = {"severity": {"$eq": severity_filter}}
        elif min_cvss:
            # Single condition
            filters = {"cvss_score": {"$gte": min_cvss}}
        
        return filters if filters else None
    
    def _format_results(self, results):
        """Format search results for display"""
        formatted_results = []
        
        for i in range(len(results['documents'][0])):
            distance = results['distances'][0][i] if results['distances'] else None
        
            # Convert distance to proper similarity score
            if distance is not None:
                # If using cosine distance: similarity = 1 - distance
                # If using Euclidean distance: we need a different approach
                # For now, use exponential decay to get positive values
                similarity_score = np.exp(-distance)  # This gives values between 0 and 1
            else:
                similarity_score = 0.0
            result = {
                'document': results['documents'][0][i],
                'metadata': results['metadatas'][0][i],
                'distance': results['distances'][0][i] if results['distances'] else None,
                'similarity_score': similarity_score
            }
            formatted_results.append(result)
        
        # Sort by similarity score (highest first)
        formatted_results.sort(key=lambda x: x['similarity_score'], reverse=True)

        return formatted_results
    
    def find_similar_vulnerabilities(self, cve_description, n_results=5):
        """Find vulnerabilities similar to a given description"""
        return self.semantic_search(cve_description, n_results)