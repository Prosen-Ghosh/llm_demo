import requests
import json
import pandas as pd
from datetime import datetime, timedelta
import os

class CVEDataLoader:
    def __init__(self, data_dir="data"):
        self.data_dir = data_dir
        os.makedirs(self.data_dir, exist_ok=True)

    def fetch_nvd_data(self, years_back=3):
        base_url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
        current_year = datetime.now().year

        cve_data = []

        for year in range(current_year - years_back, current_year + 1):
            print(f"Fetching CVEs for {year}...")
            url = f"{base_url}?pubStartDate={year}-01-01T00:00:00:000 UTC-00:00&pubEndDate={year}-12-31T23:59:59:999 UTC-00:00"

            print(f"Requesting URL: {url}")
            try:
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
                response = requests.get(url, headers=headers)
                if response.status_code == 200:
                    data = response.json()
                    print(f"Fetched {len(data.get('result', {}).get('CVE_Items', []))} CVEs for {year}")
                    cve_data.extend(self._parse_cves(data))
            except Exception as e:
                print(f"Error fetching data for {year}: {e}")

        return cve_data
    
    def _parse_cves(self, data):
        """Parse NVD JSON response"""
        parsed_cves = []
        
        for item in data.get('result', {}).get('CVE_Items', []):
            cve_item = item['cve']
            cve_id = cve_item['CVE_data_meta']['ID']
            
            # Get description
            description = ""
            for desc in cve_item['description']['description_data']:
                if desc['lang'] == 'en':
                    description = desc['value']
                    break
            
            # Get CVSS score if available
            cvss_score = None
            severity = "UNKNOWN"
            if 'impact' in item and 'baseMetricV3' in item['impact']:
                cvss_score = item['impact']['baseMetricV3']['cvssV3']['baseScore']
                severity = item['impact']['baseMetricV3']['cvssV3']['baseSeverity']
            elif 'impact' in item and 'baseMetricV2' in item['impact']:
                cvss_score = item['impact']['baseMetricV2']['cvssV2']['baseScore']
                severity = item['impact']['baseMetricV2']['severity']
            
            # Get CWE information
            cwe_info = []
            if 'problemtype' in cve_item:
                for problem in cve_item['problemtype']['problemtype_data']:
                    for desc in problem['description']:
                        if 'CWE' in desc['value']:
                            cwe_info.append(desc['value'])
            
            # Get affected products
            affected_products = []
            if 'affects' in cve_item:
                for vendor in cve_item['affects'].get('vendor', {}).get('vendor_data', []):
                    for product in vendor.get('product', {}).get('product_data', []):
                        affected_products.append(f"{vendor['vendor_name']}/{product['product_name']}")
            
            parsed_cve = {
                'cve_id': cve_id,
                'description': description,
                'cvss_score': cvss_score,
                'severity': severity,
                'cwe_list': cwe_info,
                'affected_products': affected_products,
                'published_date': item.get('publishedDate', ''),
                'last_modified': item.get('lastModifiedDate', '')
            }
            parsed_cves.append(parsed_cve)
        
        return parsed_cves
    
    def load_sample_data(self):
        """Load sample CVE data for testing"""
        sample_cves = [
            {
                'cve_id': 'CVE-2021-44228',
                'description': 'Apache Log4j2 vulnerable to remote code execution when configured to use JNDI features.',
                'cvss_score': 10.0,
                'severity': 'CRITICAL',
                'cwe_list': ['CWE-502'],
                'affected_products': ['Apache/Log4j'],
                'published_date': '2021-12-10'
            },
            {
                'cve_id': 'CVE-2014-0160',
                'description': 'The Heartbleed bug allows anyone on the Internet to read the memory of systems protected by vulnerable versions of OpenSSL.',
                'cvss_score': 7.5,
                'severity': 'HIGH',
                'cwe_list': ['CWE-200'],
                'affected_products': ['OpenSSL/OpenSSL'],
                'published_date': '2014-04-07'
            },
            {
                'cve_id': 'CVE-2017-0144',
                'description': 'Windows SMB Remote Code Execution Vulnerability in Microsoft Windows.',
                'cvss_score': 8.1,
                'severity': 'HIGH',
                'cwe_list': ['CWE-119'],
                'affected_products': ['Microsoft/Windows'],
                'published_date': '2017-03-14'
            }
        ]
        return sample_cves

    def save_data(self, cve_data, filename="cve_data.json"):
        filepath = os.path.join(self.data_dir, filename)
        with open(filepath, 'w') as f:
            json.dump(cve_data, f, indent=2)
        print(f"Data saved to {filepath}")

    def load_data(self, filename="cve_data.json"):
        """Load CVE data from JSON file"""
        filepath = os.path.join(self.data_dir, filename)
        with open(filepath, 'r') as f:
            return json.load(f)
