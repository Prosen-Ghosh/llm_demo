from sentence_transformers import SentenceTransformer
import numpy as np
from sklearn.preprocessing import normalize

class EmbeddingEngine:
    def __init__(self, model_name: str = 'all-MiniLM-L6-v2'):
        self.model = SentenceTransformer(model_name)

    def generate_document_text(self, cve_data):
        documents = []

        for cve in cve_data:
            doc_text = f"""
            Vulnerability: {cve['cve_id']}
            Description: {cve['description']}
            CVSS Score: {cve['cvss_score'] if cve['cvss_score'] is not None else 'N/A'}
            Severity: {cve['severity']}
            CWE: {', '.join(cve['cwe_list']) if cve['cwe_list'] else 'N/A'}
            Affected Products: {', '.join(cve['affected_products']) if cve['affected_products'] else 'N/A'}
            """

            documents.append(doc_text.strip())

        return documents
    
    def encode_documents(self, documents):
        """Generate embeddings for CVE documents"""
        if not documents:
            raise ValueError("No documents provided for encoding")
        
        print(f"Encoding {len(documents)} documents...")
        embeddings = self.model.encode(documents, convert_to_numpy=True)
        embeddings = normalize(embeddings, axis=1, norm='l2')
        print(f"Generated embeddings shape: {embeddings.shape}")
        return embeddings
    
    def encode_query(self, query):
        """Generate embedding for search query"""
        if not query:
            raise ValueError("Empty query provided")
        
        embedding = self.model.encode([query], convert_to_numpy=True)
        # Normalize the query embedding too
        embedding = normalize(embedding, axis=1, norm='l2')
        return embedding