import streamlit as st
from src.data_loader import CVEDataLoader
from src.embedding_engine import EmbeddingEngine
from src.chroma_manager import ChromaManager
from src.search_interface import VulnerabilitySearch

# Initialize (cached for performance)
@st.cache_resource
def initialize_search_engine():
    data_loader = CVEDataLoader()
    embedding_engine = EmbeddingEngine(model_name='all-mpnet-base-v2')
    chroma_manager = ChromaManager()
    
    # Load data
    cve_data = data_loader.fetch_nvd_data()
    documents = embedding_engine.generate_document_text(cve_data)
    embeddings = embedding_engine.encode_documents(documents)
    
    # Build database
    chroma_manager.create_collection()
    chroma_manager.add_cves(cve_data, documents, embeddings)
    
    return VulnerabilitySearch(chroma_manager, embedding_engine)

# Streamlit app
def main():
    st.title("ðŸ” Vulnerability Database Semantic Search")
    st.write("Search through CVE database using natural language queries")
    
    search_engine = initialize_search_engine()
    
    # Search interface
    col1, col2, col3 = st.columns(3)
    
    with col1:
        query = st.text_input("Search Query", 
                            placeholder="e.g., remote code execution in web servers")
    
    with col2:
        severity_filter = st.selectbox("Severity Filter", 
                                     ["All", "LOW", "MEDIUM", "HIGH", "CRITICAL"])
    
    with col3:
        min_cvss = st.slider("Minimum CVSS Score", 0.0, 10.0, 0.0)
    
    n_results = st.slider("Number of Results", 1, 20, 10)
    
    if st.button("Search") and query:
        with st.spinner("Searching vulnerabilities..."):
            results = search_engine.semantic_search(
                query, 
                n_results=n_results,
                severity_filter=severity_filter if severity_filter != "All" else None,
                min_cvss=min_cvss if min_cvss > 0 else None
            )
        
        st.subheader(f"Search Results for: '{query}'")
        
        for i, result in enumerate(results, 1):
            metadata = result['metadata']
            
            with st.expander(f"{i}. {metadata['cve_id']} - {metadata['severity']} (CVSS: {metadata['cvss_score']})"):
                st.write(f"**Description:** {result['document'].split('Severity:')[0]}")
                st.write(f"**CWE:** {metadata['cwe_list']}")
                st.write(f"**Affected Products:** {metadata['affected_products']}")
                st.write(f"**Published:** {metadata['published_date']}")
                st.write(f"**Similarity Score:** {1 - result['distance']:.4f}")

if __name__ == "__main__":
    main()